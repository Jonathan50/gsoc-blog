<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>GSoC 2023 progress blog</title>
    <link rel="stylesheet" href="style.css" type="text/css">
  </head>
  <body>
    <header>
      <h1>Summer of Code 2023 progress blog</h1>
      <p class="subtitle">NetBSD</p>
      <p class="subtitle">Update Atheros Wi-Fi driver(s) for new Wi-Fi stack</p>
      <p class="subtitle">Jeandre Kruger</p>
    </header>
    <main>
      <article>
        <h2>Getting started trying stuff out</h2>
        <p class="date">
          <time datetime="2023-05-25">25<sup>th</sup> May, 2023</time>
        </p>
        <p>
          Trying to build athn(4) on the wifi topic results in lost of errors
          in multiple arnXXXX.c files.  Trying to build ath(4) on the other hand
          seemed to result in fewer errors.  So it might be better to convert
          ath first.
        </p>
        <p>
          I substituted <code>ic_macaddr</code> for <code>ic_myaddr</code>;
          made <code>newstate</code> take a VAP; replaced
          <code>ic->ic_ifp->if_softc</code> with <code>ic->ic_softc</code>;
          changed some other references; haphazardly disabled swathes of
          (important) code (a lot of important functions); and added a
          few random stopgaps.  Eventually it compiled without error;
          <code>ieee80211_ifattach</code> panicked but taking the contents of
          <code>rtwn_get_radiocaps</code> served as a stopgap.  Thus it was
          able to boot, and <code>ath0</code> was shown by sysctl.
        </p>
        <p>
          Creating a VAP with ifconfig is (unsurprisingly) still far away (it
          reported "STA mode not supported").
        </p>
      </article>
      <article>
	<h2>Basic differences in new drivers</h2>
	<p class="date">
	  <time datetime="2023-05-18">18<sup>th</sup> May, 2023</time>
	</p>
	<p>
	  As noted by
	  <a href="https://wiki.netbsd.org/Converting_drivers_to_the_new_wifi_stack/">
	    Martin's guide</a>,
	  the main difference in new style drivers is the VAP concept.  To that
	  end FreeBSD ath(4) defines <code>struct ath_vap</code>, deriving from
	  <code>struct ieee80211vap</code>.  So whereas before it would look
	  something like this:
	</p>
	<img src="old.png" alt="Old representation" height="174">
	<p>
	  Now for any driver, the representation will look more or less like
	  this: 
	</p>
	<img src="new.png" alt="New representation" height="294">
	<p>
	  By comparing with FreeBSD ath(4) & the new rtwn driver:
	</p>
	<ul>
	  <li>
	    Some new functions exist e.g. <code>ath_vap_create</code>,
	    <code>ath_vap_delete</code>, <code>ath_parent</code>.
	  </li>
	  <li>
	    Methods previously existing on the <code>struct ifnet</code> are
	    gone, e.g. <code>if_start</code> (replaced by
	    <code>ic_transmit</code>) <code>if_watchdog</code>,
	    <code>if_ioctl</code> and <code>if_init</code>.
	  </li>
	  <li>
	    Some methods previously existing on <code>struct ieee80211com</code>
	    are shifted to the VAP e.g. <code>iv_recv_mgmt</code>,
	    <code>iv_newstate</code>.
	  </li>
	  <li>
	    <code>sc_ec</code> is gone (or rather never existed in FreeBSD).
	    This only seems to affect the handling of multicast addresses.
	  </li>
	</ul>
      </article>
      <hr>
      <article>
        <h2>Basic differences (ath vs athn)</h2>
        <p class="date">
          <time datetime="2023-05-12">12<sup>th</sup> May, 2023</time>
        </p>
        <p>
          ath(4) and athn(4) support somewhat different sets of hardware.  The
          most obvious difference in implementation is that ath(4) uses the
          Atheros HAL.  This was initially a blob but
          <a href="https://www.phoronix.com/news/Njc1MA">
            open-sourced in 2009</a>.
          According to the
          <a href="https://wiki.freebsd.org/dev/ath_hal%284%29">
            FreeBSD wiki</a>,
        </p>
        <blockquote>
          <p>The Atheros HAL is an abstraction layer which attempts to hide much of the card specific configuration from the rest of the atheros wireless driver.</p>
          <p>The HAL takes care of the MAC, baseband and radio. It exports a set of routines which allow the atheros wireless driver to do certain tasks (set channel, configure TX queue, queue TX packet, queue RX buffer, setup interrupts, do calibration, set/get TX power, configure beacon parameters, enter power saving/sleep mode, etc.)</p>
        </blockquote>
        <p>
          It doesn't seem that it'll require any changes (except ah_osdep.c).
        </p>
        <p>
          So, for example, athn.c has routines that directly change particular
          registers (using <code>AR_WRITE</code> i.e. <code>sc_ops.write</code>
          which might resolve to <code>athn_pci_write</code>), the lowest-level
          routines being implemented in if_athn_pci.c & if_athn_cardbus.c,
          whereas ath.c uses the higher-level routines already provided by the HAL.
        </p>
        <p>
          <code>ath_softc</code> and <code>athn_softc</code> are the most
          important structs in both, which, presumably, will have a few mutexes
          on them when finished (as FreeBSD).  ath(4) seems to be the more
          complicated of the two drivers.
        </p>
      </article>
      <hr>
      <article>
        <h2>Beginning GSoC 2023</h2>
        <p class="date">
          <time datetime="2023-05-10">10<sup>th</sup> May, 2023</time>
        </p>
        <p>
          NetBSD is undergoing a
          <a href="https://wiki.netbsd.org/Wifi_renewal_on_hg">
            transition to a new Wi-Fi stack</a>.
          My project is to convert the drivers athn(4) and if time allows ath(4).
        </p>
        <p>
          This far I have ensured that the wifi branch builds and runs on the
          target netbook.  All the unconverted drivers need to be disabled.
          Ethernet works.  Presently it identifies as NetBSD 9.99.100.
        </p>
        <p>
          To examine:
        </p>
        <ul>
          <li>
            dev/pci/if_athn_pci.c and dev/pci/if_ath_pci.c and (perhaps
            especially) dev/ic/athn.c and dev/ic/ath.c
          </li>
          <li>other converted drivers e.g. rtwn(4)</li>
          <li>
            FreeBSD
            <a href="https://cgit.freebsd.org/src/tree/sys/dev/ath?h=main">ath(4)</a>
            &ndash; converted and seemingly a lot more code now</li>
        </ul>
        <p>
          One of the most obvious differences in the converted drivers is
          the locking (<code>mutex_init</code>, <code>mutex_enter</code>,
          <code>mutex_exit</code>).
        </p>
      </article>
    </main>
  </body>
</html>
